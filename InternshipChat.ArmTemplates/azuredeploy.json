{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "internshipchatAppBaseName": {
      "type": "string",
      "minLength": 1
    },
    "objectId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the objectID of a user"
      }
    },
    "internshipchatAppBaseSkuName": {
      "type": "string",
      "defaultValue": "F1",
      "allowedValues": [
        "F1",
        "D1",
        "B1",
        "B2",
        "B3",
        "S1",
        "S2",
        "S3",
        "P1",
        "P2",
        "P3",
        "P4"
      ],
      "metadata": {
        "description": "Describes plan's pricing tier and capacity. Check details at https://azure.microsoft.com/en-us/pricing/details/app-service/"
      }
    },
    "appbaseAdminLogin": {
      "type": "string",
      "minLength": 1
    },
    "appbaseAdminLoginPassword": {
      "type": "securestring"
    },
    "SqlServerName": {
      "type": "string",
      "minLength": 1
    },
    "internshipchatClientName": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "internshipchat-test-client"
    },
    "storageAccountName": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "internschatteststorage"
    },
    "internshipchatKeyVaultName": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "internshipchat-test-kv"
    },
    "DatabaseName": {
      "type": "string",
      "minLength": 1
    },
    "appbaseCollation": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "SQL_Latin1_General_CP1_CI_AS"
    },
    "appbaseEdition": {
      "type": "string",
      "defaultValue": "Basic",
      "allowedValues": [
        "Basic",
        "Standard",
        "Premium"
      ]
    },
    "appbaseRequestedServiceObjectiveName": {
      "type": "string",
      "defaultValue": "Basic",
      "allowedValues": [
        "Basic",
        "S0",
        "S1",
        "S2",
        "P1",
        "P2",
        "P3"
      ],
      "metadata": {
        "description": "Describes the performance level for Edition"
      }
    },
    "storageaccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_ZRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Premium_LRS"
      ]
    }
  },
  "variables": {
    "webapi-template": "https://gist.githubusercontent.com/romaniuk3/7529474bc1c0700cee22c66887e044c4/raw/94d89bf87d152fc2d32fdaf22d9114f17da72282/webapi.json",
    "sqlserverdb-template": "https://gist.githubusercontent.com/romaniuk3/8029516b2ad4a957670f67fe4804c3d1/raw/5ea6410b4b9519b3e3d95713acba834e30d34a75/sqlserverdb.json",
    "keyvault-template": "https://gist.githubusercontent.com/romaniuk3/a96c95a0bbb6537ee495699b4e35451b/raw/177d880a2acdaf37e24a0d5f25bae1992dedf854/keyvault.json"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "createapi",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'createsqlserverdb')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('webapi-template')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "internshipchatAppBaseName": {
            "value": "[parameters('internshipchatAppBaseName')]"
          },
          "internshipchatAppBaseSkuName": {
            "value": "[parameters('internshipchatAppBaseSkuName')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "createsqlserverdb",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('sqlserverdb-template')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "SqlServerName": {
            "value": "[parameters('SqlServerName')]"
          },
          "appbaseAdminLogin": {
            "value": "[parameters('appbaseAdminLogin')]"
          },
          "appbaseAdminLoginPassword": {
            "value": "[parameters('appbaseAdminLoginPassword')]"
          },
          "DatabaseName": {
            "value": "[parameters('DatabaseName')]"
          },
          "appbaseCollation": {
            "value": "[parameters('appbaseCollation')]"
          },
          "appbaseEdition": {
            "value": "[parameters('appbaseEdition')]"
          },
          "appbaseRequestedServiceObjectiveName": {
            "value": "[parameters('appbaseRequestedServiceObjectiveName')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "createkeyvault",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'createapi')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('keyvault-template')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "internshipchatKeyVaultName": {
            "value": "[parameters('internshipchatKeyVaultName')]"
          },
          "objectId": {
            "value": "[parameters('objectId')]"
          },
          "webApiObjectId": {
            "value": "[reference(resourceId('Microsoft.Web/sites', parameters('internshipchatAppBaseName')), '2021-02-01', 'Full').identity.principalId]"
          }
        }
      }
    }
  ],
  "outputs": {
    //"storageKey": {
    //  "type": "string",
    //  "value": "[reference('createstorageaccount').outputs.storageAccountKey.value]"
    //},
    "databaseConnectionString": {
      "type": "string",
      "value": "[reference('createsqlserverdb').outputs.connectionString.value]"
    }
  }
}
